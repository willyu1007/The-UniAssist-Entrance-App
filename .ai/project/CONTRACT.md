# Project Contract (Repo-level)

The Project Contract is the **single source of truth** for the repository's **project governance** system.
All project-governance skills and scripts MUST follow the Project Contract.

> Note: `.ai/project/state.json` is **not** governed by this contract. It is feature/state data managed by `node .ai/scripts/ctl-project-state.mjs`.

## 0. Scope
- The repository uses a project hub under `.ai/project/<project>/` (default project: `main`).
- Task execution documentation remains under one or more `dev-docs` roots (module-friendly).
- The Project Contract governs:
  - IDs and status enums
  - Scanning rules (multi-root)
  - Validation/lint policy
  - Sync/writeback policy

## 1. Sources of Truth (SoT)

### 1.1 Task progress (SoT)
**Authoritative file:** `dev-docs/**/active/<task>/00-overview.md`

Rules:
- Under the `## Status` section, there MUST be a bullet:
  - `- State: <status>`
- `<status>` MUST be a **single value** (not a list, not an enum hint).
- Allowed `<status>` values: `planned`, `in-progress`, `blocked`, `done`

Archive rule:
- If a task directory lives under `dev-docs/**/archive/<task>/`, its **effective** status is `archived` regardless of the `State:` value.

### 1.2 Task identity (SoT)
**Authoritative file:** `dev-docs/**/active/<task>/.ai-task.yaml` (and the same file under `archive/`)

Governed here:
- `task_id` (stable primary key, `T-xxx`)
- `project` (default: `main`)

The task meta file MAY include a `status` field for display, but the field is **not** authoritative for task progress.

### 1.3 Project semantic graph (SoT)
**Authoritative file:** `.ai/project/<project>/registry.yaml`

Governed here:
- Milestones (`M-xxx`)
- Features (`F-xxx`)
- Requirements (`R-xxx`)
- Mappings between Milestone/Feature/Requirement/Task
- `project.task_doc_roots` configuration for scanning

### 1.4 Derived views (non-SoT)
Files:
- `.ai/project/<project>/dashboard.md`
- `.ai/project/<project>/feature-map.md`
- `.ai/project/<project>/task-index.md`

These MAY contain manual notes, but any section marked as AUTO-GENERATED is **not authoritative** and MUST be regenerated by sync.

## 2. Object model

### 2.1 IDs
- Project: `P-xxx`
- Milestone: `M-xxx`
- Feature: `F-xxx`
- Requirement: `R-xxx`
- Task: `T-xxx`

IDs are stable and MUST NOT be reused.

### 2.2 Reserved system IDs
- `M-000`: Inbox / Triage milestone
- `F-000`: Inbox / Untriaged feature

System IDs are reserved and MUST NOT be reassigned.

## 3. Status model

### 3.1 Task statuses
Allowed:
- `planned`
- `in-progress`
- `blocked`
- `done`
- `archived`

Notes:
- `archived` is derived from the task directory location under `archive/`.
- `blocked` is not "ahead" of `in-progress` for drift checks.

### 3.2 Feature/Requirement statuses
Allowed:
- `planned`
- `in-progress`
- `blocked`
- `done`
- `cut` (scope removed)

### 3.3 Milestone statuses
Allowed:
- `planned`
- `in-progress`
- `blocked`
- `done`

## 4. Task meta file: `.ai-task.yaml`

### 4.1 Location
- Active: `dev-docs/**/active/<task>/.ai-task.yaml`
- Archived: `dev-docs/**/archive/<task>/.ai-task.yaml`

### 4.2 Minimal schema
```yaml
version: 1
task_id: T-012
project: main
```

### 4.3 Optional fields
```yaml
slug: my-task-slug
status: in-progress
updated: "YYYY-MM-DD"
keywords:
  - keyword1
  - keyword2
```

### 4.4 Validation rules
- `version` must be `1`
- `task_id` must match `^T-\\d{3}$`
- `project` must match the project slug (default: `main`)
- If `slug` is present, the value MUST equal the task directory name
- If `status` is present, the value MUST match the allowed task status enum
- If `updated` is present, the value MUST match `YYYY-MM-DD`

## 5. Project registry file: `registry.yaml`

### 5.1 Location
- `.ai/project/<project>/registry.yaml`

### 5.2 Minimal expectations
- Must include top-level keys:
  - `version`
  - `project`
  - `milestones`
  - `features`
  - `requirements`
  - `tasks`

### 5.3 Task consistency rules
For any task that has `.ai-task.yaml`:
- The task MUST exist in `registry.yaml.tasks[]`
- `dev_docs_path` MUST point to the actual task directory
- `registry.yaml.tasks[].status` MUST equal the **effective** task status derived from the task bundle:
  - Active tasks: from `00-overview.md` `State:`
  - Archived tasks: `archived`

If inconsistent:
- `lint` MUST report an error
- `sync --apply` MUST repair the registry entry (status and `dev_docs_path`)

## 6. dev-docs roots scanning

### 6.1 Config-first
Preferred configuration (in `.ai/project/<project>/registry.yaml`):
```yaml
project:
  task_doc_roots:
    - dev-docs
    - modules/foo/dev-docs
```

### 6.2 Auto-discovery fallback
If `task_doc_roots` is missing or empty:
- Scan the repo for directories named `dev-docs` that contain `active/` or `archive/`.
- Each such directory is treated as a task-doc root.

### 6.3 Conflict rules (lint errors)
- `task_id` must be unique across the entire repo (across all roots).
- If the same `slug` appears in multiple roots with different `task_id`, lint MUST error (prevents drift).

## 7. Lint policy (warnings vs errors)

### 7.1 Migration policy
During migration:
- Missing `.ai-task.yaml` is a **warning** (non-blocking).
- If `.ai-task.yaml` exists, validate the file strictly.

### 7.2 Drift and human verification warnings
- If `.ai-task.yaml.status` is "ahead" of the task bundle status, lint SHOULD warn.
- If task status is `done` and `00-overview.md` has unchecked Acceptance criteria checkboxes, lint SHOULD warn.

## 8. Change control
- The Project Contract is **read-only by default**.
- Update `CONTRACT.md` only when explicitly requested and approved, and record the change in the project changelog.

## 9. Skill selection (description-only)

The Project Contract defines **data sources of truth** and invariants.
The Project Contract intentionally does not define LLM routing rules.

Skill selection is governed by each skillâ€™s frontmatter `description` (and the skill body for execution guidance).
When selection drifts, refine the relevant skill description instead of adding navigation logic to `.ai/project/CONTRACT.md`.
